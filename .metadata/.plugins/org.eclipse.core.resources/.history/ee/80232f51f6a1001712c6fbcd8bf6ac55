/*
 * Level.c
 *
 *  Created on: 29/06/2017
 *      Author: Jefferson
 */


#include "LED_B.h"
#include "LED_G.h"
#include "LED_R.h"

#include "application.h"
#include "Tank.h"

// Indiciação de fim de conversão
volatile	bool AD_finished;

//Buffer com os dados lidos do AD
static uint16_t	ADValues[AD1_CHANNEL_COUNT];

static Tank		tank;


// Handles da fila de publicação de informações ao consumidores
QueueHandle_t	xQueueTank;

// Handles da Task
TaskHandle_t	xHandleDataTask;

static const TickType_t xTaskDelay	= (500 / portTICK_PERIOD_MS);

void tank_task(void){

	AD_finished = false;

	if(AD1_Measure(true)==ERR_OK){

		while (!AD_finished) {}

		if(AD1_GetValue16(&ADValues[0])==ERR_OK){

			adInfo.Level = ADValues[0];

		    if(xQueueSendToBack( xQueueTank ,  &adInfo, ( TickType_t ) 1 ) ){

		    	xTaskNotify( xHandleCallBackTask, BIT_UPDATE_AD , eSetBits );
		    }
		}
	}

	vTaskDelay(xTaskDelay);
}
//------------------------------------------------------------------------

void lock(void){

	LED_R_On();
	LED_G_Off();
}
//------------------------------------------------------------------------

void unLock(void){

	LED_G_On();
	LED_R_Off();
}
//------------------------------------------------------------------------

void tank_init(void){

	AD_finished		= false;
	xQueueTank		= xQueueCreate( 1, sizeof( Tank ));
}
//-----------------------------------------------------------------------------
